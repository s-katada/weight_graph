#!/usr/bin/env ruby
require 'google/apis/calendar_v3'
require 'googleauth'
require 'dotenv/load'
require_relative '../config/environment'

# 認証フェーズ
scopes = [Google::Apis::CalendarV3::AUTH_CALENDAR_READONLY]
CREDENTIALS_PATH = 'bin/credentials.json'
credentials = Google::Auth::ServiceAccountCredentials.make_creds(
  json_key_io: File.open(CREDENTIALS_PATH),
  scope: scopes
)

credentials = credentials.fetch_access_token!

# Google Calendar APIクライアントのセットアップ
Calendar = Google::Apis::CalendarV3
calendar_api = Calendar::CalendarService.new
calendar_api.authorization = credentials
calendar_api.key = ENV['API_KEY']

# イベントの取得
begin
  response = calendar_api.list_events(ENV['CALENDAR_ID'],
                                      single_events: true,
                                      order_by: 'startTime',
                                      time_min: Time.new(2023, 7, 1).iso8601,
                                      time_max: Time.new(2023, 7, 31).iso8601)

  events = response.items.map do |event|
    next unless /^\d+\.\d+$/.match?(event.summary)
    start = event.start.date_time || event.start.date
    { date: start.to_date, weight: event.summary }
  end.compact
  events.each { |event| WeightLog.create(event) }
rescue Google::Apis::AuthorizationError
  puts 'Authorization Error: Please check your credentials.'
rescue StandardError => e
  puts "Error fetching events: #{e.message}"
end
